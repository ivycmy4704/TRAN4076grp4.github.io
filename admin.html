<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - ProGen AI</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    /* ---- Colorful Admin Modal ---- */
    #adminModal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex; align-items: center;
      justify-content: center; z-index: 9999;
    }
    .modal-content {
      background: #fff; padding: 2.5rem; border-radius: 16px; width: 380px;
      box-shadow: 0 20px 40px rgba(0,0,0,.3);
      border: 1px solid rgba(255,255,255,0.2);
      position: relative;
      overflow: hidden;
    }
    .modal-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
    }
    .modal-content h3 { 
      margin-top: 0; 
      text-align: center;
      color: #333;
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .modal-content .input-group { margin-bottom: 1.5rem; }
    .modal-content label { 
      display: block; 
      margin-bottom: .6rem; 
      font-weight: 600;
      color: #555;
    }
    .modal-content input { 
      width: 100%; 
      padding: 12px; 
      border: 2px solid #e1e5e9; 
      border-radius: 8px; 
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    .modal-content input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      outline: none;
    }
    .modal-actions { 
      display: flex; 
      justify-content: space-between; 
      gap: 1rem; 
      margin-top: 2rem;
    }
    .modal-actions button { 
      padding: 12px 24px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      flex: 1;
    }
    .modal-actions .btn-primary { 
      background: linear-gradient(135deg, #667eea, #764ba2);
      color:#fff; 
    }
    .modal-actions .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    .modal-actions .btn-secondary { 
      background: #f8f9fa; 
      color: #666;
      border: 2px solid #e1e5e9;
    }
    .modal-actions .btn-secondary:hover {
      background: #e9ecef;
      transform: translateY(-1px);
    }

    /* Additional styles for login history and tickets */
    .login-history { margin-top: 2rem; }
    .history-item { 
      background: #f8f9fa; 
      padding: 0.75rem; 
      margin-bottom: 0.5rem; 
      border-radius: 8px; 
      border-left: 4px solid #667eea;
      transition: all 0.3s ease;
    }
    .history-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .ticket-item { 
      background: #fff; 
      padding: 1.5rem; 
      margin-bottom: 1.5rem; 
      border-radius: 12px; 
      border: 1px solid #e1e5e9;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    .ticket-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .ticket-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 1rem;
    }
    .ticket-status { 
      padding: 0.4rem 1rem; 
      border-radius: 20px; 
      font-size: 0.8rem; 
      font-weight: bold;
    }
    .status-open { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-closed { background: #f8d7da; color: #721c24; border: 1px solid #f1b0b7; }
    .status-pending { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    .ticket-message { 
      background: #f8f9fa; 
      padding: 1rem; 
      border-radius: 8px; 
      margin-top: 0.5rem;
      border-left: 3px solid #667eea;
    }
    
    /* User stats */
    .user-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 2rem;
      border-radius: 12px;
      text-align: center;
      color: white;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
    }
    .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
      display: block;
      margin-bottom: 0.5rem;
    }
    .stat-label {
      font-size: 1rem;
      opacity: 0.9;
    }

    /* Enhanced table styles */
    .table {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .table th {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 1rem;
      font-weight: 600;
    }
    .table td {
      padding: 1rem;
      border-bottom: 1px solid #e1e5e9;
    }
    .table tr:hover {
      background: #f8f9fa;
    }

    /* Button enhancements */
    .btn-sm {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-success:hover {
      background: #218838;
      transform: translateY(-1px);
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-1px);
    }
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-1px);
    }

    /* Search bar enhancement */
    .search-bar {
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      margin-bottom: 1.5rem;
    }
    .search-bar:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      outline: none;
    }

    /* Questionnaire Styles */
    .questionnaires-container {
      max-height: 600px;
      overflow-y: auto;
    }

    .questionnaire-item {
      background: #fff;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 12px;
      border: 1px solid #e1e5e9;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }

    .questionnaire-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .questionnaire-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #f8f9fa;
    }

    .questionnaire-company {
      font-size: 1.3rem;
      font-weight: bold;
      color: #333;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .questionnaire-date {
      color: #666;
      font-size: 0.9rem;
    }

    .questionnaire-section {
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .questionnaire-section h4 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      color: #333;
      font-size: 1.1rem;
    }

    .questionnaire-field {
      margin-bottom: 0.5rem;
      display: flex;
      align-items: flex-start;
    }

    .questionnaire-field strong {
      min-width: 200px;
      color: #555;
      font-weight: 600;
    }

    .questionnaire-field span {
      flex: 1;
      color: #333;
      line-height: 1.4;
    }

    .products-grid {
      display: grid;
      gap: 1rem;
      margin-top: 1rem;
    }

    .product-card {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #e1e5e9;
      border-left: 4px solid #28a745;
    }

    .product-card h5 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      color: #28a745;
      font-size: 1rem;
    }

    .no-questionnaires {
      text-align: center;
      padding: 3rem;
      color: #666;
      font-style: italic;
      background: #f8f9fa;
      border-radius: 12px;
    }
  </style>
</head>
<body>

  <!-- ==== ADMIN LOGIN MODAL ==== -->
  <div id="adminModal">
    <div class="modal-content">
      <h3>üîê Admin Login</h3>
      <form id="adminLoginForm">
        <div class="input-group">
          <label for="adminName">üë§ Admin Name</label>
          <input type="text" id="adminName" required placeholder="Enter admin name" />
        </div>
        <div class="input-group">
          <label for="adminPass">üîí Password</label>
          <input type="password" id="adminPass" required placeholder="Enter password" />
        </div>
        <div class="modal-actions">
          <button type="button" id="cancelBtn" class="btn-secondary">Cancel</button>
          <button type="submit" class="btn-primary">Login ‚Üí</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ==== MAIN ADMIN UI (hidden until logged in) ==== -->
  <div id="adminPanel" style="display:none;">
    <nav class="navbar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
      <div class="logo" style="color: white; font-size: 1.5rem; font-weight: bold;">üéØ Admin Panel - ProGen AI</div>
      <div><a href="index.html" id="logoutLink" style="color: white; text-decoration: none; font-weight: 500;">üö™ Logout</a></div>
    </nav>

    <div class="container">
      <!-- User Statistics -->
      <div class="user-stats" id="userStats">
        <!-- Stats will be populated by JavaScript -->
      </div>

      <div class="card">
        <h2>üë• Manage Customers</h2>
        <input type="text" id="search" placeholder="üîç Search by company or email..." class="search-bar" oninput="renderUsers()" />

        <table id="userTable" class="table">
          <thead>
            <tr>
              <th>üè¢ Company</th>
              <th>üìß Email</th>
              <th>üè≠ Industry</th>
              <th>ü™ô Credits</th>
              <th>üïí Last Login</th>
              <th>‚ö° Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h2>üìä User Login History</h2>
        <div id="loginHistory" class="login-history">
          <!-- Login history will be populated here -->
        </div>
      </div>

      <div class="card">
        <h2>üé´ Support Tickets & DMs</h2>
        <div id="tickets" class="tickets-container">
          <!-- Tickets will be populated here -->
        </div>
      </div>

      <!-- NEW: Questionnaire Data Section -->
      <div class="card">
        <h2>üìù Customer Questionnaires</h2>
        <div id="questionnaires" class="questionnaires-container">
          <!-- Questionnaire data will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <!-- ==== SCRIPTS ==== -->
  <script>
    // ---------- CONFIG ----------
    const ADMIN_NAME = 'admin';
    const ADMIN_PASS = 'admin001';

    // ---------- ELEMENTS ----------
    const modal      = document.getElementById('adminModal');
    const panel      = document.getElementById('adminPanel');
    const form       = document.getElementById('adminLoginForm');
    const cancelBtn  = document.getElementById('cancelBtn');
    const logoutLink = document.getElementById('logoutLink');

    // ---------- SESSION HELPERS ----------
    const setAdminSession = () => sessionStorage.setItem('adminAuth', 'true');
    const clearAdminSession = () => sessionStorage.removeItem('adminAuth');
    const isAdminAuthenticated = () => sessionStorage.getItem('adminAuth') === 'true';

    // ---------- AUTH CHECK ON LOAD ----------
    if (isAdminAuthenticated()) {
      modal.style.display = 'none';
      panel.style.display = 'block';
      // Load data when authenticated
      setTimeout(() => {
        loadAdminData();
      }, 100);
    }

    // ---------- FORM SUBMIT ----------
    form.addEventListener('submit', e => {
      e.preventDefault();
      const name = document.getElementById('adminName').value.trim();
      const pass = document.getElementById('adminPass').value;

      if (name === ADMIN_NAME && pass === ADMIN_PASS) {
        setAdminSession();
        modal.style.display = 'none';
        panel.style.display = 'block';
        // Load data after login
        setTimeout(() => {
          loadAdminData();
        }, 100);
      } else {
        alert('‚ùå Invalid admin credentials');
        document.getElementById('adminName').focus();
      }
    });

    // ---------- CANCEL BUTTON ----------
    cancelBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    // ---------- LOGOUT ----------
    logoutLink.addEventListener('click', e => {
      e.preventDefault();
      clearAdminSession();
      window.location.href = 'index.html';
    });

    // ---------- ADMIN DATA FUNCTIONS ----------
    function loadAdminData() {
      renderUserStats();
      renderUsers();
      renderLoginHistory();
      renderTickets();
      renderQuestionnaires(); // NEW: Load questionnaire data
    }

    function renderUserStats() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const loginHistory = JSON.parse(localStorage.getItem('userLoginHistory') || '[]');
      const tickets = JSON.parse(localStorage.getItem('supportTickets') || '[]');
      
      // NEW: Count questionnaires
      const questionnaireCount = countQuestionnaires();
      
      const statsContainer = document.getElementById('userStats');
      statsContainer.innerHTML = `
        <div class="stat-card">
          <span class="stat-number">${users.length}</span>
          <span class="stat-label">Total Users</span>
        </div>
        <div class="stat-card">
          <span class="stat-number">${loginHistory.length}</span>
          <span class="stat-label">Total Logins</span>
        </div>
        <div class="stat-card">
          <span class="stat-number">${tickets.length}</span>
          <span class="stat-label">Support Tickets</span>
        </div>
        <div class="stat-card">
          <span class="stat-number">${questionnaireCount}</span>
          <span class="stat-label">Questionnaires</span>
        </div>
      `;
    }

    // NEW: Function to count questionnaires
    function countQuestionnaires() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      let count = 0;

      users.forEach(user => {
        const userQuestionnaireKey = `questionnaireData_${user.id}`;
        const questionnaireData = localStorage.getItem(userQuestionnaireKey);
        if (questionnaireData) {
          count++;
        }
      });

      // Also check global questionnaireData
      const globalQuestionnaireData = localStorage.getItem('questionnaireData');
      if (globalQuestionnaireData) {
        count = Math.max(count, 1); // At least one questionnaire exists
      }

      return count;
    }

    // Function to render users table
    function renderUsers() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const search = document.getElementById('search').value.toLowerCase();
      const tbody = document.querySelector('#userTable tbody');
      
      console.log('üîç Total users found:', users.length);
      console.log('üì¶ Users data:', users);

      if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 3rem; color: #666; font-style: italic;">No users registered yet. Users will appear here after they create accounts.</td></tr>';
        return;
      }

      const filteredUsers = users.filter(u => 
        u.company?.toLowerCase().includes(search) || 
        u.email?.toLowerCase().includes(search)
      );

      if (filteredUsers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 3rem; color: #666; font-style: italic;">No users match your search criteria.</td></tr>';
        return;
      }

      tbody.innerHTML = filteredUsers.map(user => `
        <tr>
          <td><strong>${user.company || 'N/A'}</strong></td>
          <td>${user.email || 'N/A'}</td>
          <td><span style="background: #e9ecef; padding: 4px 8px; border-radius: 12px; font-size: 0.875rem;">${user.industry || 'N/A'}</span></td>
          <td><input type="number" value="${user.credits || 0}" class="credit-input" data-id="${user.id}" style="width:70px; padding:6px; text-align:center; border: 1px solid #ddd; border-radius: 4px;" min="0" /></td>
          <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() + ' ' + new Date(user.lastLogin).toLocaleTimeString() : 'Never'}</td>
          <td>
            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
              <button class="btn-sm btn-success" onclick="saveCredits(${user.id})" title="Save Credits">üíæ Save</button>
              <button class="btn-sm btn-secondary" onclick="editUser(${user.id})" title="Edit User">‚úèÔ∏è Edit</button>
              <button class="btn-sm btn-danger" onclick="deleteUser(${user.id})" title="Delete User">üóëÔ∏è Delete</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Function to render login history
    function renderLoginHistory() {
      const historyContainer = document.getElementById('loginHistory');
      const loginHistory = JSON.parse(localStorage.getItem('userLoginHistory') || '[]');
      
      console.log('üìã Login history found:', loginHistory.length);

      if (loginHistory.length === 0) {
        historyContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem; font-style: italic;">No login history available. User logins will appear here when users sign in.</p>';
        return;
      }

      // Sort by most recent first
      loginHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      historyContainer.innerHTML = loginHistory.slice(0, 20).map(login => `
        <div class="history-item">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <strong>${login.company || 'Unknown Company'}</strong><br>
              <small style="color: #666;">${login.email || 'Unknown Email'}</small>
            </div>
            <div style="text-align: right;">
              <small style="color: #999;">${new Date(login.timestamp).toLocaleDateString()}</small><br>
              <small style="color: #ccc;">${new Date(login.timestamp).toLocaleTimeString()}</small>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Function to render tickets - FIXED TO SHOW ALL TICKETS
    function renderTickets() {
      const ticketsContainer = document.getElementById('tickets');
      // Read from the correct localStorage key used by index/register pages
      const tickets = JSON.parse(localStorage.getItem('supportTickets') || '[]');
      
      console.log('üé´ Support tickets found:', tickets.length);
      console.log('üì¨ Tickets data:', tickets);

      if (tickets.length === 0) {
        ticketsContainer.innerHTML = `
          <div style="text-align: center; padding: 3rem; color: #666; font-style: italic;">
            <p>üì≠ No support tickets available yet.</p>
            <p style="font-size: 0.9rem; margin-top: 1rem;">Tickets will appear here when users submit support requests from the login or register pages.</p>
          </div>
        `;
        return;
      }

      // Sort by most recent first
      tickets.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      ticketsContainer.innerHTML = tickets.map(ticket => `
        <div class="ticket-item">
          <div class="ticket-header">
            <strong>${ticket.company || 'Guest User'} - ${ticket.subject}</strong>
            <span class="ticket-status status-${ticket.status || 'open'}">${(ticket.status || 'open').toUpperCase()}</span>
          </div>
          <div><strong>üìß From:</strong> ${ticket.email || 'Email not provided'}</div>
          <div class="ticket-message">
            <strong>üí¨ Message:</strong><br>${ticket.message}
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
            <small style="color: #666;">üìÖ Submitted: ${new Date(ticket.createdAt).toLocaleString()}</small>
            <div style="display: flex; gap: 8px;">
              <button class="btn-sm btn-success" onclick="updateTicketStatus('${ticket.id}', 'closed')" ${ticket.status === 'closed' ? 'disabled' : ''}>‚úì Close</button>
              <button class="btn-sm btn-secondary" onclick="updateTicketStatus('${ticket.id}', 'open')" ${ticket.status === 'open' ? 'disabled' : ''}>‚Üª Reopen</button>
              <button class="btn-sm btn-danger" onclick="deleteTicket('${ticket.id}')">üóëÔ∏è Delete</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // NEW: Function to render questionnaires
    function renderQuestionnaires() {
      console.log("üìù Rendering questionnaires...");
      
      const questionnairesContainer = document.getElementById('questionnaires');
      if (!questionnairesContainer) {
        console.error("‚ùå Questionnaires container not found!");
        return;
      }

      // Get all users
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      console.log(`üë• Total users: ${users.length}`);

      let allQuestionnaires = [];

      // Collect questionnaire data from all users
      users.forEach(user => {
        // Try to get questionnaire data from user's storage
        const userQuestionnaireKey = `questionnaireData_${user.id}`;
        const questionnaireData = localStorage.getItem(userQuestionnaireKey);
        
        if (questionnaireData) {
          try {
            const data = JSON.parse(questionnaireData);
            allQuestionnaires.push({
              ...data,
              userEmail: user.email,
              userCompany: user.company,
              userId: user.id,
              submittedAt: data.submittedAt || new Date().toISOString()
            });
          } catch (error) {
            console.error('Error parsing questionnaire data for user:', user.email, error);
          }
        }
        
        // Also check the global questionnaireData (for backward compatibility)
        if (user.id === JSON.parse(localStorage.getItem('currentUser') || '{}').id) {
          const globalQuestionnaireData = localStorage.getItem('questionnaireData');
          if (globalQuestionnaireData) {
            try {
              const data = JSON.parse(globalQuestionnaireData);
              // Check if we already have this user's data
              const existingQuestionnaire = allQuestionnaires.find(q => q.userId === user.id);
              if (!existingQuestionnaire) {
                allQuestionnaires.push({
                  ...data,
                  userEmail: user.email,
                  userCompany: user.company,
                  userId: user.id,
                  submittedAt: data.submittedAt || new Date().toISOString()
                });
              }
            } catch (error) {
              console.error('Error parsing global questionnaire data:', error);
            }
          }
        }
      });

      console.log(`üìã Total questionnaires found: ${allQuestionnaires.length}`);
      console.log("üìù Questionnaires data:", allQuestionnaires);

      if (allQuestionnaires.length === 0) {
        questionnairesContainer.innerHTML = `
          <div class="no-questionnaires">
            <p style="font-size: 1.2rem; margin-bottom: 1rem;">üì≠ No questionnaires submitted yet</p>
            <p style="font-size: 0.9rem;">Questionnaires will appear here when users complete the questionnaire form.</p>
            <p style="font-size: 0.8rem; margin-top: 2rem; color: #999;">
              üí° Users can access the questionnaire from their dashboard after logging in.
            </p>
          </div>
        `;
        return;
      }

      // Sort by most recent first
      allQuestionnaires.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));

      questionnairesContainer.innerHTML = allQuestionnaires.map((questionnaire, index) => `
        <div class="questionnaire-item">
          <div class="questionnaire-header">
            <div class="questionnaire-company">
              üè¢ ${questionnaire.userCompany || questionnaire.brandName || 'Unknown Company'}
            </div>
            <div class="questionnaire-date">
              üìÖ ${new Date(questionnaire.submittedAt).toLocaleString()}
            </div>
          </div>
          
          <div class="questionnaire-field">
            <strong>üìß User Email:</strong>
            <span>${questionnaire.userEmail || 'N/A'}</span>
          </div>
          
          <!-- Basic Brand Information -->
          <div class="questionnaire-section">
            <h4>üè∑Ô∏è Basic Brand Information</h4>
            <div class="questionnaire-field">
              <strong>Brand Name:</strong>
              <span>${questionnaire.brandName || 'N/A'}</span>
            </div>
            <div class="questionnaire-field">
              <strong>Address:</strong>
              <span>${questionnaire.address || 'N/A'}</span>
            </div>
            <div class="questionnaire-field">
              <strong>Phone:</strong>
              <span>${questionnaire.phone || 'N/A'}</span>
            </div>
            <div class="questionnaire-field">
              <strong>Opening Hours:</strong>
              <span>${questionnaire.openingHours || 'N/A'}</span>
            </div>
            <div class="questionnaire-field">
              <strong>Holiday Hours:</strong>
              <span>${questionnaire.holidayHours || 'N/A'}</span>
            </div>
            <div class="questionnaire-field">
              <strong>Advance Booking:</strong>
              <span>${questionnaire.advanceBooking || 'N/A'}</span>
            </div>
            <div class="questionnaire-field">
              <strong>Payment Methods:</strong>
              <span>${Array.isArray(questionnaire.paymentMethods) ? questionnaire.paymentMethods.join(', ') : questionnaire.paymentMethods || 'N/A'}</span>
            </div>
          </div>
          
          <!-- Brand Details -->
          <div class="questionnaire-section">
            <h4>üìä Brand Details</h4>
            <div class="questionnaire-field">
              <strong>Company Profile:</strong>
              <span>${questionnaire.companyProfile || 'N/A'}</span>
            </div>
            <div class="questionnaire-field">
              <strong>Branches:</strong>
              <span>${questionnaire.branches || 'N/A'}</span>
            </div>
            <div class="questionnaire-field">
              <strong>Awards:</strong>
              <span>${questionnaire.awards || 'N/A'}</span>
            </div>
            <div class="questionnaire-field">
              <strong>Product Categories:</strong>
              <span>${questionnaire.productCategories || 'N/A'}</span>
            </div>
            <div class="questionnaire-field">
              <strong>Key Promoted Categories:</strong>
              <span>${questionnaire.keyPromotedCategories || 'N/A'}</span>
            </div>
            <div class="questionnaire-field">
              <strong>Brand Advantages:</strong>
              <span>${questionnaire.brandAdvantages || 'N/A'}</span>
            </div>
            <div class="questionnaire-field">
              <strong>Target Audience:</strong>
              <span>${questionnaire.targetAudience || 'N/A'}</span>
            </div>
            <div class="questionnaire-field">
              <strong>Consumption Threshold:</strong>
              <span>${questionnaire.consumptionThreshold || 'N/A'}</span>
            </div>
            <div class="questionnaire-field">
              <strong>Copywriting Theme:</strong>
              <span>${questionnaire.copywritingTheme || 'N/A'}</span>
            </div>
            <div class="questionnaire-field">
              <strong>Suitable Adjectives:</strong>
              <span>${questionnaire.suitableAdjectives || 'N/A'}</span>
            </div>
            <div class="questionnaire-field">
              <strong>Other Notes:</strong>
              <span>${questionnaire.otherNotes || 'N/A'}</span>
            </div>
          </div>
          
          <!-- Products -->
          ${questionnaire.products && questionnaire.products.length > 0 ? `
            <div class="questionnaire-section">
              <h4>üì¶ Products (${questionnaire.products.length})</h4>
              <div class="products-grid">
                ${questionnaire.products.map((product, productIndex) => `
                  <div class="product-card">
                    <h5>${productIndex + 1}. ${product.productName || 'Unnamed Product'}</h5>
                    <div class="questionnaire-field">
                      <strong>Category:</strong>
                      <span>${product.productCategory || 'N/A'}</span>
                    </div>
                    <div class="questionnaire-field">
                      <strong>Features:</strong>
                      <span>${product.productFeatures || 'N/A'}</span>
                    </div>
                    <div class="questionnaire-field">
                      <strong>Problems Solved:</strong>
                      <span>${product.problemsSolved || 'N/A'}</span>
                    </div>
                    <div class="questionnaire-field">
                      <strong>Advantages:</strong>
                      <span>${product.advantages || 'N/A'}</span>
                    </div>
                    <div class="questionnaire-field">
                      <strong>Price:</strong>
                      <span>${product.price || 'N/A'}</span>
                    </div>
                    <div class="questionnaire-field">
                      <strong>Discount:</strong>
                      <span>${product.discount || 'N/A'}</span>
                    </div>
                    <div class="questionnaire-field">
                      <strong>Adjectives:</strong>
                      <span>${product.productAdjectives || 'N/A'}</span>
                    </div>
                    <div class="questionnaire-field">
                      <strong>Unsuitable Crowd:</strong>
                      <span>${product.unsuitableCrowd || 'N/A'}</span>
                    </div>
                    <div class="questionnaire-field">
                      <strong>Notes:</strong>
                      <span>${product.productNotes || 'N/A'}</span>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : `
            <div class="questionnaire-section">
              <h4>üì¶ Products</h4>
              <p style="color: #666; font-style: italic; margin: 0;">No products specified</p>
            </div>
          `}
          
          <div style="display: flex; justify-content: flex-end; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e1e5e9;">
            <button class="btn-sm btn-danger" onclick="deleteQuestionnaire('${questionnaire.userId}')"
                    style="background: linear-gradient(135deg, #dc3545, #c82333); border: none; padding: 8px 16px; border-radius: 6px; color: white; cursor: pointer; transition: all 0.3s ease;"
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(220, 53, 69, 0.3)';"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
              üóëÔ∏è Delete Questionnaire
            </button>
          </div>
        </div>
      `).join('');

      console.log("‚úÖ Questionnaires rendered successfully");
    }

    // NEW: Function to delete questionnaire
    function deleteQuestionnaire(userId) {
      console.log(`üóëÔ∏è Attempting to delete questionnaire for user: ${userId}`);
      
      const confirmDelete = confirm(`‚ö†Ô∏è Are you sure you want to delete this questionnaire?\n\nThis action cannot be undone!`);
      
      if (!confirmDelete) {
        console.log('‚ùå Questionnaire deletion cancelled');
        return;
      }

      // Delete user-specific questionnaire data
      localStorage.removeItem(`questionnaireData_${userId}`);
      
      // Also check and delete from global questionnaireData if it belongs to this user
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
      if (currentUser.id === userId) {
        localStorage.removeItem('questionnaireData');
      }
      
      alert('‚úÖ Questionnaire deleted successfully!');
      console.log(`üóëÔ∏è Questionnaire deleted for user: ${userId}`);
      
      renderQuestionnaires();
      renderUserStats(); // Update stats
    }

    // Function to update ticket status
    function updateTicketStatus(ticketId, status) {
      let tickets = JSON.parse(localStorage.getItem('supportTickets') || '[]');
      const ticketIndex = tickets.findIndex(t => t.id === ticketId);
      
      if (ticketIndex === -1) {
        alert('‚ùå Ticket not found!');
        return;
      }

      const oldStatus = tickets[ticketIndex].status;
      tickets[ticketIndex].status = status;
      tickets[ticketIndex].updatedAt = new Date().toISOString();
      
      localStorage.setItem('supportTickets', JSON.stringify(tickets));
      
      alert(`‚úÖ Ticket status updated from "${oldStatus}" to "${status}"`);
      console.log(`Ticket ${ticketId} status updated to: ${status}`);
      
      renderTickets();
      renderUserStats();
    }

    // Function to delete ticket
    function deleteTicket(ticketId) {
      let tickets = JSON.parse(localStorage.getItem('supportTickets') || '[]');
      const ticket = tickets.find(t => t.id === ticketId);
      
      if (!ticket) {
        alert('‚ùå Ticket not found!');
        return;
      }

      const confirmDelete = confirm(`Are you sure you want to delete this support ticket?\n\nSubject: ${ticket.subject}\nFrom: ${ticket.company || 'Guest'}\n\nThis action cannot be undone!`);
      
      if (!confirmDelete) {
        console.log('Ticket deletion cancelled');
        return;
      }

      tickets = tickets.filter(t => t.id !== ticketId);
      localStorage.setItem('supportTickets', JSON.stringify(tickets));
      
      alert('‚úÖ Support ticket deleted successfully!');
      console.log(`Ticket deleted: ${ticket.subject}`);
      
      renderTickets();
      renderUserStats();
    }

    // User management functions
    function saveCredits(id) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === id);
      
      if (userIndex === -1) {
        alert('‚ùå User not found!');
        return;
      }

      const creditInput = document.querySelector(`.credit-input[data-id="${id}"]`);
      const newCredits = parseInt(creditInput.value) || 0;
      
      if (newCredits < 0) {
        alert('‚ùå Credits cannot be negative!');
        creditInput.value = users[userIndex].credits || 0;
        return;
      }

      users[userIndex].credits = newCredits;
      localStorage.setItem('users', JSON.stringify(users));
      
      alert(`‚úÖ Credits updated to ${newCredits} for ${users[userIndex].company}`);
      
      renderUsers();
      renderUserStats();
    }

    function editUser(id) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const user = users.find(u => u.id === id);
      
      if (!user) {
        alert('‚ùå User not found!');
        return;
      }

      const newCompany = prompt('Edit Company Name:', user.company || '');
      if (newCompany === null) return;
      
      if (newCompany.trim() === '') {
        alert('‚ùå Company name cannot be empty!');
        return;
      }

      user.company = newCompany.trim();
      user.updatedAt = new Date().toISOString();
      
      localStorage.setItem('users', JSON.stringify(users));
      
      alert('‚úÖ User information updated successfully!');
      
      renderUsers();
    }

    function deleteUser(id) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const user = users.find(u => u.id === id);
      
      if (!user) {
        alert('‚ùå User not found!');
        return;
      }

      const confirmDelete = confirm(`Are you sure you want to delete user:\n\n"${user.company}" (${user.email})\n\nThis action cannot be undone!`);
      
      if (!confirmDelete) return;

      const updatedUsers = users.filter(u => u.id !== id);
      localStorage.setItem('users', JSON.stringify(updatedUsers));
      
      alert('‚úÖ User deleted successfully!');
      
      renderUsers();
      renderUserStats();
      renderLoginHistory();
    }

    // Add refresh function
    function refreshAdminData() {
      loadAdminData();
      alert('üîÑ Admin data refreshed!');
    }

    // Make functions globally available
    window.renderUsers = renderUsers;
    window.saveCredits = saveCredits;
    window.editUser = editUser;
    window.deleteUser = deleteUser;
    window.renderTickets = renderTickets;
    window.updateTicketStatus = updateTicketStatus;
    window.deleteTicket = deleteTicket;
    window.renderQuestionnaires = renderQuestionnaires;
    window.deleteQuestionnaire = deleteQuestionnaire;
    window.refreshAdminData = refreshAdminData;
  </script>
</body>
</html>
